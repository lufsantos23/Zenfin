<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZenFin v3.9 - Planejador Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#0f172a', card: '#1e293b', primary: '#6366f1', income: '#10b981', expense: '#f43f5e', warning: '#f59e0b',
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #000; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        .modal-bg { background-color: rgba(0,0,0,0.9); backdrop-filter: blur(5px); }
        .month-active { background-color: #6366f1; color: white; font-weight: bold; border: none; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
        
        .toggle-checkbox:checked { right: 0; border-color: #10b981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10b981; }
    </style>
</head>
<body class="text-slate-200 flex justify-center min-h-screen bg-black">

    <div class="w-full max-w-md bg-dark h-screen overflow-y-auto hide-scrollbar relative shadow-2xl border-x border-slate-800 flex flex-col">
        
        <div class="pt-6 pb-2 bg-dark/95 sticky top-0 z-20 backdrop-blur-md border-b border-slate-800">
            <div class="px-6 flex justify-between items-center mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-primary to-purple-500 flex items-center justify-center font-bold text-xs">LF</div>
                    <span class="font-bold text-sm">ZenFin</span>
                </div>
                <div class="flex gap-3">
                    <button onclick="carregarDados()" class="w-8 h-8 rounded-full hover:bg-slate-800 flex items-center justify-center"><i class="fas fa-sync-alt text-slate-400 text-xs"></i></button>
                    <button onclick="alert('Agora voc√™ pode lan√ßar Contas Fixas (Aluguel, Internet) usando a op√ß√£o REPETIR!')" class="w-8 h-8 rounded-full hover:bg-slate-800 flex items-center justify-center"><i class="fas fa-infinity text-primary text-xs"></i></button>
                </div>
            </div>
            <div class="flex gap-2 overflow-x-auto px-6 pb-2 hide-scrollbar" id="monthSelector"></div>
        </div>

        <div class="flex-1 overflow-y-auto hide-scrollbar pb-28">
            
            <div class="px-6 mt-6 text-center">
                <p class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Previs√£o do M√™s</p>
                <div class="flex gap-4 mt-4">
                    <div class="glass flex-1 p-3 rounded-2xl border-b-2 border-income/50">
                        <p class="text-[10px] text-slate-400">Receitas</p>
                        <p class="font-bold text-income text-base" id="totalIncome">R$ 0,00</p>
                    </div>
                    <div class="glass flex-1 p-3 rounded-2xl border-b-2 border-expense/50">
                        <p class="text-[10px] text-slate-400">Despesas</p>
                        <p class="font-bold text-expense text-base" id="totalExpense">R$ 0,00</p>
                    </div>
                </div>
            </div>

            <div class="mt-8">
                <div class="px-6 flex justify-between items-end mb-3">
                    <h3 class="font-bold text-white text-sm">Contas & Cart√µes</h3>
                </div>
                <div id="accountList" class="flex gap-4 overflow-x-auto px-6 pb-4 hide-scrollbar snap-x">
                    <div class="text-xs text-slate-500 py-4">Carregando...</div>
                </div>
            </div>

            <div class="px-6 mt-4">
                <div class="glass p-5 rounded-3xl">
                    <h3 class="font-bold text-white mb-4 text-xs uppercase tracking-wider">Distribui√ß√£o</h3>
                    <div class="relative h-48 flex items-center justify-center">
                        <canvas id="expenseChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="px-6 pt-8">
                <h3 class="font-bold text-white mb-4 text-sm">Extrato</h3>
                <div id="loading" class="text-center text-slate-500 text-xs py-4 hidden"><i class="fas fa-circle-notch fa-spin"></i></div>
                <div id="transactionList" class="space-y-3 pb-6"></div>
            </div>
        </div>

        <div class="fixed bottom-6 w-full max-w-md flex justify-center pointer-events-none z-30">
            <button onclick="abrirModalAdd()" class="pointer-events-auto w-16 h-16 bg-gradient-to-r from-primary to-purple-600 rounded-full shadow-lg shadow-primary/40 text-white flex items-center justify-center hover:scale-110 active:scale-95 transition text-2xl">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <div id="modalAdd" class="fixed inset-0 modal-bg z-50 hidden flex items-end sm:items-center justify-center p-4 fade-in overflow-y-auto">
            <div class="bg-card w-full max-w-sm rounded-3xl border border-slate-700 shadow-2xl overflow-hidden relative my-auto">
                <button onclick="fecharModalAdd()" class="absolute top-4 right-4 text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>

                <div class="flex border-b border-slate-700">
                    <button onclick="mudarAba('transacao')" id="tabTransacao" class="flex-1 py-4 text-sm font-bold text-primary border-b-2 border-primary bg-slate-800/50">Transa√ß√£o</button>
                    <button onclick="mudarAba('conta')" id="tabConta" class="flex-1 py-4 text-sm font-bold text-slate-500 hover:text-white">Nova Conta</button>
                </div>

                <div id="formTransacao" class="p-6 space-y-4">
                    <input type="hidden" id="editId">
                    <input type="hidden" id="editOldVal">
                    <input type="hidden" id="editOldType">
                    <input type="hidden" id="editOldDone">
                    <input type="hidden" id="editRecurId"> <h3 id="formTitle" class="text-center text-white font-bold hidden bg-orange-500/20 py-2 rounded-lg text-sm mb-2">‚úèÔ∏è Editando</h3>

                    <div class="flex gap-3">
                        <div class="flex-1">
                            <label class="text-xs text-slate-400 ml-1">Valor</label>
                            <input type="number" id="tValor" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-white text-xl focus:border-primary outline-none" placeholder="0,00" step="0.01">
                        </div>
                        <div class="w-1/3">
                            <label class="text-xs text-slate-400 ml-1">Data</label>
                            <input type="date" id="tData" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-white text-sm focus:border-primary outline-none">
                        </div>
                    </div>

                    <div>
                        <label class="text-xs text-slate-400 ml-1">Descri√ß√£o</label>
                        <input type="text" id="tDesc" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-white focus:border-primary outline-none" placeholder="Ex: Aluguel, Sal√°rio...">
                    </div>

                    <div class="flex gap-2">
                        <select id="tTipo" class="bg-slate-900 border border-slate-700 rounded-xl p-3 text-white text-sm outline-none flex-1">
                            <option value="expense">Despesa üî¥</option>
                            <option value="income">Receita üü¢</option>
                        </select>
                        <select id="tCat" class="bg-slate-900 border border-slate-700 rounded-xl p-3 text-white text-sm outline-none flex-1">
                            <option>Alimenta√ß√£o</option><option>Transporte</option><option>Casa</option><option>Mercado</option>
                            <option>Sa√∫de</option><option>Educa√ß√£o</option><option>Lazer</option><option>Compras</option>
                            <option>Viagem</option><option>Streaming</option><option>Pet</option><option>Beleza</option>
                            <option>Investimento</option><option>Contas</option><option>Sal√°rio</option><option>Outros</option>
                        </select>
                    </div>

                    <div>
                        <label class="text-xs text-slate-400 ml-1">Conta:</label>
                        <select id="tConta" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-white text-sm focus:border-primary outline-none">
                            <option>Carregando...</option>
                        </select>
                    </div>

                    <div id="divRecurso" class="bg-slate-800/30 p-3 rounded-xl border border-slate-700 border-dashed">
                        <div class="flex items-center gap-2 mb-2">
                            <input type="checkbox" id="tRecur" class="w-4 h-4 rounded bg-slate-700 border-slate-500 text-primary focus:ring-primary">
                            <label for="tRecur" class="text-sm text-slate-300">Repetir (Fixa/Parcelada)?</label>
                        </div>
                        <div id="divRecurMeses" class="hidden flex items-center gap-2">
                            <span class="text-xs text-slate-400">Repetir por:</span>
                            <select id="tRecurQtd" class="bg-slate-900 border border-slate-600 rounded-lg p-1 text-white text-xs outline-none">
                                <option value="2">2 meses</option>
                                <option value="3">3 meses</option>
                                <option value="6">6 meses</option>
                                <option value="12" selected>1 ano (Fixa)</option>
                                <option value="24">2 anos (Fixa)</option>
                            </select>
                        </div>
                    </div>

                    <div id="divEditFuture" class="hidden bg-orange-500/10 p-3 rounded-xl border border-orange-500/30">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="tUpdateFuture" class="w-4 h-4 rounded bg-slate-700 border-orange-500 text-orange-500 focus:ring-orange-500">
                            <label for="tUpdateFuture" class="text-xs text-orange-200">Aplicar mudan√ßa nos meses futuros tamb√©m?</label>
                        </div>
                    </div>

                    <div class="flex items-center justify-between bg-slate-800/50 p-3 rounded-xl border border-slate-700">
                        <span class="text-sm text-slate-300">Status: <strong id="statusLabel">Efetivado</strong></span>
                        <div class="relative inline-block w-12 h-6 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" id="tDone" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" checked onclick="atualizarLabelStatus()"/>
                            <label for="tDone" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-700 cursor-pointer"></label>
                        </div>
                    </div>

                    <button id="btnSalvar" onclick="salvarTransacao()" class="w-full bg-primary py-3 rounded-xl font-bold text-white hover:bg-indigo-500 mt-2">Salvar</button>
                </div>

                <div id="formConta" class="p-6 space-y-4 hidden">
                    <div>
                        <label class="text-xs text-slate-400 ml-1">Nome da Conta</label>
                        <input type="text" id="cNome" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-white focus:border-primary outline-none" placeholder="Ex: Nubank, Carteira...">
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 ml-1">Tipo</label>
                        <select id="cTipo" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-white text-sm outline-none">
                            <option value="checking">Conta Corrente / Carteira üíµ</option>
                            <option value="credit">Cart√£o de Cr√©dito üí≥</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 ml-1">Saldo Inicial</label>
                        <input type="number" id="cSaldo" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-white text-xl focus:border-primary outline-none" placeholder="0,00">
                    </div>
                    <button onclick="salvarConta()" class="w-full bg-emerald-500 py-3 rounded-xl font-bold text-white hover:bg-emerald-600 mt-4">Criar Conta</button>
                </div>
            </div>
        </div>

        <div id="modalContaOptions" class="fixed inset-0 modal-bg z-50 hidden flex items-center justify-center p-6 fade-in">
            <div class="bg-card w-full max-w-sm rounded-3xl border border-slate-700 shadow-2xl p-6 text-center">
                <h3 class="text-xl font-bold text-white mb-2" id="mContaTitulo">Gerenciar Conta</h3>
                <input type="hidden" id="mContaId">
                <div class="space-y-3 mt-6">
                    <button onclick="editarNomeConta()" class="w-full py-3 rounded-xl bg-slate-700 text-white hover:bg-slate-600 transition font-bold flex items-center justify-center gap-2"><i class="fas fa-pen"></i> Editar Nome</button>
                    <button onclick="excluirContaConfirmada()" class="w-full py-3 rounded-xl bg-red-500/10 text-red-500 border border-red-500/20 hover:bg-red-500 hover:text-white transition font-bold flex items-center justify-center gap-2"><i class="fas fa-trash"></i> Excluir Conta</button>
                    <button onclick="fecharModalConta()" class="w-full py-3 rounded-xl bg-transparent border border-slate-700 text-slate-400 hover:text-white transition">Cancelar</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- üî¥ SUAS CHAVES AQUI üî¥ ---
        const SUPABASE_URL = "https://djsagvjjabtdbpgclvze.supabase.co"; 
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqc2FndmpqYWJ0ZGJwZ2NsdnplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3NjI2NDIsImV4cCI6MjA4MTMzODY0Mn0.4rrcyKaq8wEa5wL6jWrScccqfBBFmVcNfVuwIMV4PDo"; 
        const USER_ID = "d8f7fc92-38c9-402f-a7b1-ce2c277836d8";

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);
        let myChart = null;
        let dataAtual = new Date();
        let listaContasCache = []; 

        async function carregarDados() {
            renderMonthSelector();
            await carregarContas(); 
            carregarTransacoes();
        }

        // === L√ìGICA DE INTERFACE ===
        // Mostra o seletor de meses se "Recorrente" for marcado
        document.getElementById('tRecur').addEventListener('change', function() {
            const div = document.getElementById('divRecurMeses');
            if(this.checked) div.classList.remove('hidden'); else div.classList.add('hidden');
        });

        // === 1. CONTAS ===
        async function carregarContas() {
            const container = document.getElementById('accountList');
            const select = document.getElementById('tConta');
            const { data: accounts, error } = await db.from('accounts').select('*').order('created_at');
            if (error) { console.error("Erro Contas:", error); return; }

            listaContasCache = accounts;
            container.innerHTML = '';
            const oldVal = select.value;
            select.innerHTML = '';

            container.innerHTML += `
                <div onclick="abrirModalAdd(); mudarAba('conta')" class="cursor-pointer snap-center min-w-[60px] h-40 rounded-2xl bg-slate-800/50 border border-slate-700 border-dashed flex flex-col items-center justify-center hover:bg-slate-800 text-slate-500 hover:text-primary transition">
                    <i class="fas fa-plus text-xl mb-1"></i><span class="text-[10px]">Nova</span>
                </div>
            `;

            accounts.forEach(acc => {
                const saldo = parseFloat(acc.balance);
                const isCredit = acc.type === 'credit';
                const option = document.createElement('option');
                option.value = acc.id;
                option.text = acc.name + ` (R$ ${saldo.toFixed(2)})`;
                select.appendChild(option);

                const gradiente = isCredit ? 'bg-gradient-to-br from-[#820AD1] to-[#45056e]' : 'bg-gradient-to-br from-slate-800 to-slate-900 border border-slate-700';
                
                container.innerHTML += `
                <div onclick="abrirOpcoesConta('${acc.id}', '${acc.name}')" class="cursor-pointer snap-center min-w-[260px] h-40 rounded-2xl ${gradiente} p-5 flex flex-col justify-between relative overflow-hidden shadow-lg hover:scale-[1.02] transition">
                    <div class="absolute right-0 top-0 p-4 opacity-10 text-white text-6xl"><i class="fas ${isCredit?'fa-cc-mastercard':'fa-wallet'}"></i></div>
                    <div class="flex justify-between items-start z-10">
                        <span class="text-xs text-slate-300 font-bold tracking-wide">${acc.name}</span>
                        ${isCredit ? '<i class="fab fa-cc-mastercard text-white/50 text-xl"></i>' : ''}
                    </div>
                    <div class="z-10">
                        <p class="text-[10px] text-slate-400 uppercase mb-1">${isCredit ? 'Fatura' : 'Saldo'}</p>
                        <p class="text-2xl font-bold text-white">R$ ${saldo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                        <div class="flex items-center gap-1 mt-1 text-white/30 text-[10px]"><i class="fas fa-cog"></i> <span>Gerenciar</span></div>
                    </div>
                </div>`;
            });
            if(oldVal && select.querySelector(`option[value="${oldVal}"]`)) select.value = oldVal;
        }

        // === GERENCIAMENTO DE CONTA ===
        function abrirOpcoesConta(id, nome) {
            document.getElementById('mContaTitulo').innerText = nome;
            document.getElementById('mContaId').value = id;
            document.getElementById('modalContaOptions').classList.remove('hidden');
        }
        function fecharModalConta() { document.getElementById('modalContaOptions').classList.add('hidden'); }
        async function editarNomeConta() {
            const id = document.getElementById('mContaId').value;
            const novoNome = prompt("Novo nome:");
            if(!novoNome) return;
            await db.from('accounts').update({ name: novoNome }).eq('id', id);
            fecharModalConta(); carregarDados();
        }
        async function excluirContaConfirmada() {
            const id = document.getElementById('mContaId').value;
            if(!confirm("‚ö†Ô∏è Apagar conta E TODAS as despesas dela?")) return;
            await db.from('transactions').delete().eq('account_id', id);
            await db.from('accounts').delete().eq('id', id);
            fecharModalConta(); carregarDados();
        }
        async function salvarConta() {
            const nome = document.getElementById('cNome').value;
            const tipo = document.getElementById('cTipo').value;
            const saldo = parseFloat(document.getElementById('cSaldo').value);
            if (!nome || isNaN(saldo)) return alert("Preencha tudo!");
            const { error } = await db.from('accounts').insert({ user_id: USER_ID, name: nome, type: tipo, balance: saldo });
            if (error) alert("Erro: " + error.message); else { fecharModalAdd(); carregarDados(); }
        }

        // === 2. TRANSA√á√ïES (AGORA COM RECORR√äNCIA) ===
        
        function getDataInput(isoDateString) {
            if(!isoDateString) return new Date().toISOString().split('T')[0];
            return isoDateString.split('T')[0];
        }

        function atualizarLabelStatus() {
            const isDone = document.getElementById('tDone').checked;
            const label = document.getElementById('statusLabel');
            if(isDone) {
                label.innerHTML = "Efetivado <span class='text-income text-xs'>(Afeta Saldo)</span>";
                label.className = "font-bold text-white";
            } else {
                label.innerHTML = "Agendado <span class='text-warning text-xs'>(Previs√£o)</span>";
                label.className = "font-bold text-slate-400";
            }
        }

        window.editarTransacao = function(id, desc, valor, tipo, cat, contaId, created_at, done, recurId) {
            abrirModalAdd(); mudarAba('transacao');
            
            document.getElementById('editId').value = id;
            document.getElementById('editOldVal').value = valor;
            document.getElementById('editOldType').value = tipo;
            document.getElementById('editOldDone').value = done; 
            document.getElementById('editRecurId').value = recurId || ""; // Guarda o ID de recorr√™ncia
            
            document.getElementById('tDesc').value = desc;
            document.getElementById('tValor').value = valor;
            document.getElementById('tTipo').value = tipo;
            document.getElementById('tCat').value = cat;
            document.getElementById('tData').value = getDataInput(created_at);
            document.getElementById('tDone').checked = (done === 'true' || done === true);
            
            // L√≥gica: Se tem recurId, mostra a op√ß√£o de "Editar Futuras"
            if(recurId && recurId !== "null" && recurId !== "undefined") {
                document.getElementById('divEditFuture').classList.remove('hidden');
            } else {
                document.getElementById('divEditFuture').classList.add('hidden');
            }
            
            // Esconde op√ß√£o de CRIAR recorr√™ncia na edi√ß√£o (muito complexo transformar normal em recorrente)
            document.getElementById('divRecurso').classList.add('hidden');

            const selectConta = document.getElementById('tConta');
            if(selectConta.querySelector(`option[value="${contaId}"]`)) selectConta.value = contaId;

            const btn = document.getElementById('btnSalvar');
            btn.innerText = "Atualizar";
            btn.classList.replace('bg-primary', 'bg-orange-500');
            document.getElementById('formTitle').classList.remove('hidden');
            atualizarLabelStatus();
        }

        async function salvarTransacao() {
            const id = document.getElementById('editId').value;
            const valor = parseFloat(document.getElementById('tValor').value);
            const desc = document.getElementById('tDesc').value;
            const tipo = document.getElementById('tTipo').value;
            const cat = document.getElementById('tCat').value;
            const contaId = document.getElementById('tConta').value;
            const dataVal = document.getElementById('tData').value;
            const isDone = document.getElementById('tDone').checked;
            
            // Novos campos
            const isRecur = document.getElementById('tRecur').checked;
            const recurQtd = parseInt(document.getElementById('tRecurQtd').value);
            const updateFuture = document.getElementById('tUpdateFuture').checked;
            const recurIdExistente = document.getElementById('editRecurId').value;

            if (!desc || isNaN(valor) || !contaId || !dataVal) return alert("Preencha tudo!");

            const contaAtual = listaContasCache.find(c => c.id === contaId);
            let saldoConta = parseFloat(contaAtual.balance);

            if (id) {
                // === EDI√á√ÉO ===
                const valorAntigo = parseFloat(document.getElementById('editOldVal').value);
                const tipoAntigo = document.getElementById('editOldType').value;
                const doneAntigo = (document.getElementById('editOldDone').value === 'true');

                // 1. Reverte saldo antigo (se estava pago)
                if (doneAntigo) { if (tipoAntigo === 'income') saldoConta -= valorAntigo; else saldoConta += valorAntigo; }
                
                // 2. Aplica novo saldo (se est√° pago)
                if (isDone) { if (tipo === 'income') saldoConta += valor; else saldoConta -= valor; }

                // 3. Salva no Banco
                const dataFinal = `${dataVal}T12:00:00`;
                await db.from('transactions').update({ description: desc, amount: valor, type: tipo, category: cat, account_id: contaId, created_at: dataFinal, done: isDone }).eq('id', id);
                await db.from('accounts').update({ balance: saldoConta }).eq('id', contaId);

                // 4. M√°gica: Atualizar Futuros?
                if (updateFuture && recurIdExistente) {
                    // Atualiza descri√ß√£o, valor, tipo e categoria das futuras
                    await db.from('transactions')
                        .update({ description: desc, amount: valor, type: tipo, category: cat })
                        .eq('recurring_id', recurIdExistente)
                        .gt('created_at', dataFinal); 
                }

            } else {
                // === NOVO LAN√áAMENTO ===
                const dataFinal = `${dataVal}T12:00:00`;
                
                // Gerar Recorr√™ncia?
                let newRecurId = null;
                if(isRecur && recurQtd > 1) {
                    newRecurId = crypto.randomUUID(); 
                }

                // Insere o PRIMEIRO
                const { error } = await db.from('transactions').insert({ 
                    user_id: USER_ID, description: desc, amount: valor, type: tipo, category: cat, 
                    account_id: contaId, created_at: dataFinal, done: isDone, recurring_id: newRecurId 
                });
                
                if (error) return alert("Erro: " + error.message);

                // Atualiza Saldo (s√≥ do primeiro, se pago)
                if (isDone) {
                    if (tipo === 'income') saldoConta += valor; else saldoConta -= valor;
                    await db.from('accounts').update({ balance: saldoConta }).eq('id', contaId);
                }

                // === LOOP DE CLONAGEM (FUTURO) ===
                if (isRecur && recurQtd > 1) {
                    let inserts = [];
                    let dataBase = new Date(dataVal);
                    
                    for(let i = 1; i < recurQtd; i++) {
                        let proximaData = new Date(dataBase);
                        proximaData.setMonth(dataBase.getMonth() + i);
                        let isoDate = proximaData.toISOString().split('T')[0] + "T12:00:00";
                        
                        inserts.push({
                            user_id: USER_ID, description: desc, amount: valor, type: tipo, category: cat, 
                            account_id: contaId, created_at: isoDate, done: false, recurring_id: newRecurId 
                        });
                    }
                    if(inserts.length > 0) {
                        await db.from('transactions').insert(inserts);
                    }
                }
            }
            
            fecharModalAdd();
            carregarDados();
        }

        window.efetivarTransacao = async function(id, valor, tipo, contaId) {
            if(!confirm("Confirmar pagamento?")) return;
            const contaAtual = listaContasCache.find(c => c.id === contaId);
            if(contaAtual) {
                let novoSaldo = parseFloat(contaAtual.balance);
                if (tipo === 'income') novoSaldo += valor; else novoSaldo -= valor;
                await db.from('transactions').update({ done: true }).eq('id', id);
                await db.from('accounts').update({ balance: novoSaldo }).eq('id', contaId);
                carregarDados();
            }
        }

        window.deletarTransacao = async function(id, valor, tipo, contaId, done) {
            if(!confirm("Excluir?")) return;
            const { error } = await db.from('transactions').delete().eq('id', id);
            if (done === true || done === 'true') {
                const contaAtual = listaContasCache.find(c => c.id === contaId);
                if (contaAtual) {
                    let novoSaldo = parseFloat(contaAtual.balance);
                    if (tipo === 'income') novoSaldo -= valor; else novoSaldo += valor; 
                    await db.from('accounts').update({ balance: novoSaldo }).eq('id', contaId);
                }
            }
            carregarDados();
        }

        async function carregarTransacoes() {
            const list = document.getElementById('transactionList');
            const loading = document.getElementById('loading');
            loading.style.display = 'block'; list.innerHTML = '';

            const ano = dataAtual.getFullYear(), mes = dataAtual.getMonth();
            const inicio = new Date(ano, mes, 1).toISOString(), fim = new Date(ano, mes + 1, 0, 23, 59, 59).toISOString();
            const { data: trans } = await db.from('transactions').select('*').gte('created_at', inicio).lte('created_at', fim).order('created_at', {ascending:false});
            loading.style.display = 'none';

            let receita = 0, despesa = 0, cats = {};
            if(!trans || trans.length === 0) { list.innerHTML = '<div class="text-center text-slate-500 text-xs py-8">Sem lan√ßamentos</div>'; }
            else {
                trans.forEach(t => {
                    const val = parseFloat(t.amount);
                    if(t.type === 'income') receita += val; else { despesa += val; cats[t.category] = (cats[t.category]||0)+val; }
                    
                    const isExp = t.type === 'expense';
                    const dia = new Date(t.created_at).getDate();
                    const isDone = t.done;
                    const isRecur = t.recurring_id ? true : false;
                    
                    const opacityClass = isDone ? 'opacity-100' : 'opacity-60 grayscale';
                    const iconStatus = isDone 
                        ? `<i class="fas fa-check-circle text-income text-xs" title="Efetivado"></i>` 
                        : `<button onclick="efetivarTransacao('${t.id}', ${val}, '${t.type}', '${t.account_id}')" class="bg-primary px-2 py-1 rounded text-[10px] text-white font-bold hover:scale-110 transition">PAGAR</button>`;

                    const iconRecur = isRecur ? '<i class="fas fa-sync-alt text-[8px] text-primary ml-1" title="Fixa/Parcelada"></i>' : '';

                    list.innerHTML += `
                    <div class="group flex items-center justify-between p-3 rounded-xl bg-slate-900/40 border border-slate-800/50 mb-2 ${opacityClass} transition hover:bg-slate-800">
                        <div class="flex items-center gap-3">
                            <div class="flex flex-col items-center justify-center w-8 h-8 rounded-lg bg-slate-800 text-slate-400 border border-slate-700">
                                <span class="text-[8px] uppercase font-bold">DIA</span>
                                <span class="text-xs font-bold text-white">${dia}</span>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-slate-200">${t.description} ${iconRecur}</p>
                                <p class="text-[10px] text-slate-500">${t.category} ‚Ä¢ ${isDone ? 'Pago' : 'Pendente'}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="text-right">
                                <span class="block text-xs font-bold ${isExp ? 'text-expense' : 'text-income'}">${isExp?'-':'+'} ${val.toLocaleString('pt-BR',{minimumFractionDigits:2})}</span>
                                <div class="mt-1">${iconStatus}</div>
                            </div>
                            <div class="flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition">
                                <button onclick="editarTransacao('${t.id}', '${t.description}', ${val}, '${t.type}', '${t.category}', '${t.account_id}', '${t.created_at}', ${isDone}, '${t.recurring_id}')" class="text-blue-400 hover:text-white"><i class="fas fa-pen text-xs"></i></button>
                                <button onclick="deletarTransacao('${t.id}', ${val}, '${t.type}', '${t.account_id}', ${isDone})" class="text-red-500 hover:text-white"><i class="fas fa-trash text-xs"></i></button>
                            </div>
                        </div>
                    </div>`;
                });
            }
            document.getElementById('totalIncome').innerText = `R$ ${receita.toLocaleString('pt-BR',{minimumFractionDigits:2})}`;
            document.getElementById('totalExpense').innerText = `R$ ${despesa.toLocaleString('pt-BR',{minimumFractionDigits:2})}`;
            atualizarGrafico(cats);
        }

        function renderMonthSelector() {
            const container = document.getElementById('monthSelector');
            const meses = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
            container.innerHTML = '';
            meses.forEach((m, i) => {
                const btn = document.createElement('button');
                btn.className = `month-item px-4 py-1.5 rounded-full text-xs border border-slate-700 text-slate-400 whitespace-nowrap hover:bg-slate-800 ${i===dataAtual.getMonth()?'month-active':''}`;
                btn.innerText = m; btn.onclick=()=>{dataAtual.setMonth(i); carregarDados();};
                container.appendChild(btn);
            });
            setTimeout(()=>{const a=document.querySelector('.month-active'); if(a) a.scrollIntoView({behavior:'smooth',inline:'center'})},200);
        }
        function abrirModalAdd(){ 
            document.getElementById('modalAdd').classList.remove('hidden'); 
            const btn = document.getElementById('btnSalvar');
            if(btn.innerText.includes("Atualizar")) {
                document.getElementById('editId').value = "";
                document.getElementById('tDesc').value = "";
                document.getElementById('tValor').value = "";
                document.getElementById('tDone').checked = true;
                document.getElementById('tData').value = new Date().toISOString().split('T')[0];
                document.getElementById('divEditFuture').classList.add('hidden'); // Esconde futuro
                document.getElementById('divRecurso').classList.remove('hidden'); // Mostra recur
                btn.innerText = "Salvar";
                btn.classList.replace('bg-orange-500', 'bg-primary');
                document.getElementById('formTitle').classList.add('hidden');
                atualizarLabelStatus();
            } else {
                document.getElementById('tData').value = new Date().toISOString().split('T')[0];
                document.getElementById('divEditFuture').classList.add('hidden');
                document.getElementById('divRecurso').classList.remove('hidden');
            }
        }
        function fecharModalAdd(){ document.getElementById('modalAdd').classList.add('hidden'); }
        function mudarAba(aba){
            document.getElementById('formTransacao').classList.add('hidden'); document.getElementById('formConta').classList.add('hidden');
            document.getElementById('tabTransacao').className = "flex-1 py-4 text-sm font-bold text-slate-500 hover:text-white border-b-2 border-transparent";
            document.getElementById('tabConta').className = "flex-1 py-4 text-sm font-bold text-slate-500 hover:text-white border-b-2 border-transparent";
            if(aba==='transacao'){ document.getElementById('formTransacao').classList.remove('hidden'); document.getElementById('tabTransacao').className = "flex-1 py-4 text-sm font-bold text-primary border-b-2 border-primary bg-slate-800/50"; } 
            else { document.getElementById('formConta').classList.remove('hidden'); document.getElementById('tabConta').className = "flex-1 py-4 text-sm font-bold text-emerald-500 border-b-2 border-emerald-500 bg-slate-800/50"; }
        }
        function getIcon(c){ const map = { 'Transporte':'fa-car','Alimenta√ß√£o':'fa-utensils','Mercado':'fa-shopping-cart','Lazer':'fa-gamepad','Casa':'fa-home','Sa√∫de':'fa-heartbeat','Educa√ß√£o':'fa-graduation-cap','Compras':'fa-shopping-bag','Viagem':'fa-plane','Streaming':'fa-ticket-alt','Pet':'fa-paw','Beleza':'fa-spa','Investimento':'fa-chart-line','Sal√°rio':'fa-money-bill-wave','Outros':'fa-cube' }; return map[c] || 'fa-wallet'; }
        function atualizarGrafico(d){ const ctx=document.getElementById('expenseChart').getContext('2d'); const v=Object.values(d); if(myChart)myChart.destroy(); Chart.register(ChartDataLabels); myChart=new Chart(ctx,{type:'doughnut',data:{labels:Object.keys(d),datasets:[{data:v,backgroundColor:['#f43f5e','#8b5cf6','#3b82f6','#10b981','#f59e0b', '#ec4899', '#6366f1', '#14b8a6'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,layout:{padding:10},plugins:{legend:{position:'right',labels:{color:'#94a3b8',usePointStyle:true,font:{size:10}}},datalabels:{color:'#fff',font:{weight:'bold',size:10},formatter:(v,c)=>(v/c.dataset.data.reduce((a,b)=>a+b,0)>0.05)?((v/c.dataset.data.reduce((a,b)=>a+b,0))*100).toFixed(0)+"%":""}},cutout:'70%'}});
        }
        function atualizarLabelStatus() { const isDone = document.getElementById('tDone').checked; const label = document.getElementById('statusLabel'); if(isDone) { label.innerHTML = "Efetivado <span class='text-income text-xs'>(Afeta Saldo)</span>"; label.className = "font-bold text-white"; } else { label.innerHTML = "Agendado <span class='text-warning text-xs'>(Previs√£o)</span>"; label.className = "font-bold text-slate-400"; } }

        carregarDados();
    </script>
</body>
</html>